<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>בניית מערך שיעור — מצב מסמך</title>
  <style>
    :root{--bg:#f4f7fb;--ink:#0b1324;--muted:#64748b;--line:#e2e8f0;--brand:#111827;--ok:#10b981;--card:#fff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Heebo,Arial;color:var(--ink)}
    header{position:sticky;top:0;background:#ffffffe6;backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:10px;align-items:center}
    .wrap{max-width:960px;margin:16px auto;padding:0 14px}
    button,select,input,textarea{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff}
    button.primary{background:linear-gradient(90deg,var(--brand),#1f2937);border:0;color:#fff;font-weight:900}

    /* Document (print-like) */
    .paper{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.05);padding:18px}
    .title{font-size:26px;font-weight:900;margin:0 0 6px}
    .meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
    .section{margin-top:16px}
    .section h3{margin:0 0 8px;border-bottom:2px solid var(--line);padding-bottom:6px}
    .exercise{border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0;display:grid;grid-template-columns:72px 1fr auto;gap:10px;align-items:center}
    .exercise img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .exercise .act button{margin-inline-start:6px}
    textarea.notes{width:100%;min-height:100px}

    /* Bank */
    details.bank{margin:12px 0}
    .bankbox{border:1px dashed var(--line);border-radius:12px;padding:10px}
    .bankgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .bankitem{border:1px solid var(--line);border-radius:12px;padding:8px}

    /* Print */
    @media print{
      header,details.bank,.bar{display:none}
      body{background:#fff}
      .wrap{max-width:none}
      .paper{border:0;box-shadow:none;padding:0}
      .exercise{page-break-inside:avoid}
    }
    .watermark{position:fixed;inset:0;pointer-events:none;opacity:.06;display:grid;place-items:center;font-size:64px;font-weight:900;color:#0f172a}
    .bar{position:sticky;bottom:10px;display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;box-shadow:0 20px 60px rgba(0,0,0,.08);margin-top:12px}
  </style>
</head>
<body>
<header>
  <strong>בניית מערך — מצב מסמך</strong>
  <div style="margin-inline-start:auto"></div>
  <button id="btn-members">אזור לקוחות</button>
  <button id="btn-admin">מסך ניהול</button>
</header>

<div class="wrap">
  <details class="bank">
    <summary><strong>➕ הוספת תרגילים מבנק התרגילים</strong></summary>
    <div class="bankbox">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <label>מקצוע:</label>
        <select id="subject"></select>
        <input id="q" placeholder="חיפוש בשם/תיאור" style="min-width:240px" />
        <button id="load">טען</button>
        <div id="teacherBox" class="muted" style="margin-inline-start:auto">מורה: —</div>
      </div>
      <div id="bank" class="bankgrid"></div>
    </div>
  </details>

  <div class="paper" id="doc">
    <input id="title" class="title" placeholder="כותרת מערך שיעור (למשל: כדורסל — שיעור 1)"/>
    <div class="meta">
      <div><label>נושא השיעור</label><input id="topic" placeholder="לדוגמה: כדרור והובלה"/></div>
      <div><label>משך שיעור (דקות)</label><input id="minutes" type="number" value="45"/></div>
    </div>

    <div class="section">
      <h3>ציוד נדרש (נאסף אוטומטית מהתרגילים)</h3>
      <div id="equipment" class="muted">אין עדיין ציוד. הוסיפו תרגילים — ואסכם כאן.</div>
    </div>

    <div class="section" id="sec-warmup">
      <h3>חלק ראשון — חימום</h3>
      <div id="warmup"></div>
    </div>

    <div class="section" id="sec-main">
      <h3>חלק שני — עיקרי</h3>
      <div id="main"></div>
    </div>

    <div class="section" id="sec-finish">
      <h3>חלק שלישי — סיום</h3>
      <div id="finish"></div>
    </div>

    <div class="section">
      <h3>הערות המורה</h3>
      <textarea id="notes" class="notes" placeholder="הערות, דגשים פדגוגיים, התאמות אישיות…"></textarea>
    </div>
  </div>

  <div class="bar">
    <button id="save" class="primary">שמור טיוטה</button>
    <button id="export" class="primary">ייצוא PDF</button>
  </div>

  <div class="watermark" id="wm" style="display:none"></div>
</div>

<script>
  const API=location.origin,$=(id)=>document.getElementById(id);
  async function jsonFetch(url,opts={}){ const r=await fetch(url,{credentials:'include',headers:{'Content-Type':'application/json'},...opts}); const d=await r.json().catch(()=>({})); if(!r.ok) throw new Error(d.error||'שגיאה'); return d; }

  let bank=[], plan={warmup:[],main:[],finish:[]}, teacherName='';

  (async()=>{
    try{ const me=await jsonFetch(`${API}/api/auth/me`); if(!me?.user) return location.href='/auth'; teacherName=me.user.fullname||me.user.email; document.getElementById('teacherBox').textContent=`מורה: ${teacherName}`; }
    catch{ return location.href='/auth'; }
    const subs=await jsonFetch(`${API}/api/subjects`); $('subject').innerHTML=subs.map(s=>`<option>${s.name}</option>`).join('');
    // טען טיוטה
    try{ const d=JSON.parse(localStorage.getItem('docPlanV1')||localStorage.getItem('draftPlanV2')||'{}'); if(d&&d.warmup){ plan={warmup:d.warmup||[], main:d.main||[], finish:d.finish||[]}; } }catch{}
    renderAll();
    await loadBank();
  })();

  async function loadBank(){ const s=$('subject').value; const url=s?`${API}/api/exercises?subject=${encodeURIComponent(s)}`:`${API}/api/exercises`; const rows=await jsonFetch(url); const q=$('q').value.toLowerCase().trim(); bank=rows.filter(r=>r.is_public && (!q || (r.name||'').toLowerCase().includes(q) || (r.description||'').toLowerCase().includes(q))); renderBank(); }

  function renderBank(){ const box=$('bank'); box.innerHTML=''; bank.forEach(r=>{ const d=document.createElement('div'); d.className='bankitem'; d.innerHTML=`<strong>${r.name}</strong><div class='muted' style='font-size:12px'>${r.subject} • ${r.category}</div><div style='display:flex;gap:6px;margin-top:6px'><button data-id='${r.id}' data-part='warmup'>➕ חימום</button><button data-id='${r.id}' data-part='main'>➕ עיקרי</button><button data-id='${r.id}' data-part='finish'>➕ סיום</button></div>`; box.appendChild(d); }); }

  $('bank').onclick=(e)=>{ const b=e.target.closest('button'); if(!b) return; const id=+b.dataset.id, key=b.dataset.part; const ex=bank.find(x=>x.id===id); if(!ex) return; plan[key].push(ex); persist(); renderAll(); };
  $('load').onclick=loadBank; $('subject').onchange=loadBank; $('q').onkeyup=(e)=>{ if(e.key==='Enter') loadBank(); };

  function renderAll(){ ['warmup','main','finish'].forEach(key=>{ const box=$(key); box.innerHTML=''; plan[key].forEach((r,i)=>{ const el=document.createElement('div'); el.className='exercise'; el.innerHTML=`${r.image_url?`<img src='${r.image_url}'>`:"<div style='width:72px;height:72px;border:1px dashed var(--line);border-radius:10px;display:grid;place-items:center;color:#94a3b8'>אין תמונה</div>"}<div><strong>${i+1}. ${r.name}</strong><div class='muted' style='font-size:12px'>${r.subject} • ${r.category}</div><div class='muted' style='font-size:13px;margin-top:4px'>${(r.description||'').replace(/\n/g,'<br>')}</div></div><div class='act'><button data-k='${key}' data-i='${i}' data-a='up'>↑</button><button data-k='${key}' data-i='${i}' data-a='down'>↓</button><button data-k='${key}' data-i='${i}' data-a='move'>↔ העבר</button><button data-k='${key}' data-i='${i}' data-a='del' style='background:#ef4444;color:#fff'>מחק</button></div>`; box.appendChild(el); }); });
    updateEquipment();
  }

  document.getElementById('doc').onclick=(e)=>{ const b=e.target.closest('button'); if(!b) return; const k=b.dataset.k, i=+b.dataset.i, a=b.dataset.a; if(k==null) return; const arr=plan[k]; if(!arr[i]) return; if(a==='up'&&i>0){ [arr[i-1],arr[i]]=[arr[i],arr[i-1]]; } else if(a==='down'&&i<arr.length-1){ [arr[i+1],arr[i]]=[arr[i],arr[i+1]]; } else if(a==='del'){ arr.splice(i,1); } else if(a==='move'){ const to = k==='warmup'?'main':(k==='main'?'finish':'warmup'); plan[to].push(arr.splice(i,1)[0]); }
    persist(); renderAll(); };

  function extractEquipment(txt=''){
    // נסה לחלץ שורה שמתחילה במילה "ציוד"
    const lines = String(txt).split(/\n|<br\s*\/?\s*>/i);
    let found=[]; lines.forEach(L=>{ const m=L.match(/^(?:ציוד|ציוד נדרש)\s*[:\-]\s*(.+)$/i); if(m){ found.push(m[1]); } });
    const raw = found.join(',');
    return raw.split(/[,•;]+/).map(s=>s.trim()).filter(Boolean);
  }
  function updateEquipment(){
    const set=new Set();
    [...plan.warmup,...plan.main,...plan.finish].forEach(ex=> extractEquipment(ex.description).forEach(x=>set.add(x)) );
    $('equipment').textContent = set.size? Array.from(set).join(', ') : 'אין עדיין ציוד. הוסיפו תרגילים — ואסכם כאן.';
  }

  function persist(){ localStorage.setItem('docPlanV1', JSON.stringify(plan)); }

  $('save').onclick=async()=>{ const payload={ title:$('title').value.trim(), topic:$('topic').value.trim(), subject:$('subject').value, totalDuration:+$('minutes').value, notes:$('notes').value, warmupIds:plan.warmup.map(x=>x.id), mainIds:plan.main.map(x=>x.id), finishIds:plan.finish.map(x=>x.id) }; if(!payload.title) return alert('כתוב כותרת'); try{ await jsonFetch(`${API}/api/lesson-plans`,{method:'POST',body:JSON.stringify(payload)}); alert('נשמר'); }catch(e){ alert(e.message); } };

  $('export').onclick=()=>{ const wm=$('wm'); wm.textContent = teacherName; wm.style.display='grid'; setTimeout(()=>{ window.print(); setTimeout(()=> wm.style.display='none', 500); }, 60); };

  $('btn-members').onclick=()=>location.href='/members';
  $('btn-admin').onclick=()=>location.href='/admin';
</script>
</body>
</html>
