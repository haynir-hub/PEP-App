<!doctype html>
<html lang="he" dir="rtl">
<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>בניית מערך שיעור — PE.P</title>
 <style>
    :root{--bg:#f4f7fb;--ink:#0b1324;--muted:#64748b;--line:#e2e8f0;--brand:#111827;--ok:#10b981;--card:#fff} *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Heebo,Arial;color:var(--ink)} header{position:sticky;top:0;background:#ffffffe6;backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:10px;align-items:center} .wrap{max-width:960px;margin:16px auto;padding:0 14px} button,select,input,textarea{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff; cursor: pointer;} button.primary{background:linear-gradient(90deg,var(--brand),#1f2937);border:0;color:#fff;font-weight:900} .paper{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.05);padding:18px} .title{font-size:26px;font-weight:900;margin:0 0 6px; width: 100%;} .meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0} .section{margin-top:16px} .section h3{margin:0 0 8px;border-bottom:2px solid var(--line);padding-bottom:6px} .exercise{border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0;display:grid;grid-template-columns:72px 1fr auto;gap:10px;align-items:center} .exercise img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:1px solid var(--line)} .exercise .act button{margin-inline-start:6px} textarea.notes{width:100%;min-height:100px} details.bank{margin:12px 0} .bankbox{border:1px dashed var(--line);border-radius:12px;padding:10px} .bankgrid{display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:8px} .bankitem{border:1px solid var(--line);border-radius:12px;padding:8px} .bar{position:sticky;bottom:10px;display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;box-shadow:0 20px 60px rgba(0,0,0,.08);margin-top:12px} .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;place-items:center;z-index:100;padding:16px;} .modal-content{background:#fff;padding:20px;border-radius:16px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;}
 </style>
</head>
<body>
<header>
  <strong>בניית מערך (PEP)</strong>
  <a href="/my-lessons-pep"><button>המערכים שלי</button></a>
  <div style="margin-inline-start:auto"></div>
  <a id="return-to-admin" href="/api/auth/return-to-admin" style="display:none; background-color: #ffc107; color: black; padding: 8px 12px; border-radius: 8px; font-weight: bold; text-decoration: none;">חזרה לניהול</a>
  <div id="teacherBox" class="muted">מורה: —</div>
</header>
<div class="wrap">
 <details class="bank" open><summary><strong>➕ הוספת תרגילים מבנק התרגילים</strong></summary>
  <div class="bankbox">
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <label>סנן לפי נושא:</label><select id="subject-filter"></select>
    </div>
    <div id="bank" class="bankgrid"></div>
  </div>
 </details>
 <div class="paper" id="doc">
  <input id="plan-name" class="title" placeholder="כותרת מערך שיעור (למשל: כדורסל — שיעור 1)"/>
  <div class="meta">
    <div><label>נושא השיעור</label><input id="topic" placeholder="לדוגמה: כדרור והובלה"/></div>
  </div>
  <div class="section"><h3>ציוד נדרש (נאסף אוטומטית)</h3><div id="equipment" class="muted">אין עדיין ציוד.</div></div>
  <div class="section" id="sec-warmup"><h3>חימום</h3><div id="warmup"></div></div>
  <div class="section" id="sec-main"><h3>עיקרי</h3><div id="main"></div></div>
  <div class="section" id="sec-finish"><h3>סיום</h3><div id="finish"></div></div>
  <div class="section"><h3>הערות המורה</h3><textarea id="notes" class="notes" placeholder="הערות, דגשים פדגוגיים..."></textarea></div>
 </div>
 <div class="bar">
  <button id="save-plan" class="primary">שמור מערך</button>
 </div>
 <div id="details-modal" class="modal-backdrop"><div class="modal-content" id="modal-box"></div></div>
</div>
<script>
    const $ = (id) => document.getElementById(id);
    let allExercises = [], allSubjects = [], lessonPlan = { warmup: [], main: [], finish: [] }, currentUser = null, currentLessonId = null;

    async function jsonFetch(url, options = {}) {
        const response = await fetch(url, { credentials: 'include', headers: { 'Content-Type': 'application/json' }, ...options });
        const data = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(data.error || 'Request failed');
        return data;
    }

    async function initializePage() {
        try {
            const meData = await jsonFetch('/api/auth/me');
            currentUser = meData.user;
            if (!currentUser) return location.href = '/auth';
            $('teacherBox').textContent = `מורה: ${currentUser.fullname || currentUser.email}`;
            if (currentUser.role === 'admin' && meData.viewAsOrg) {
                $('return-to-admin').style.display = 'inline-block';
            }

            const builderData = await jsonFetch('/api/builder-data/pep');
            allExercises = builderData.exercises;
            allSubjects = builderData.subjects;
            
            populateSubjectFilter();
            renderBank();

            const urlParams = new URLSearchParams(window.location.search);
            currentLessonId = urlParams.get('id');
            if (currentLessonId) {
                const { lesson_plan } = await jsonFetch(`/api/lesson-plans/${currentLessonId}`);
                const planData = JSON.parse(lesson_plan.plan_data);
                
                $('plan-name').value = lesson_plan.name;
                $('topic').value = lesson_plan.topic;
                $('notes').value = lesson_plan.notes;
                document.title = `עריכת מערך: ${lesson_plan.name}`;

                lessonPlan.warmup = (planData.warmup || []).map(id => lesson_plan.items.find(ex => ex.id === id)).filter(Boolean);
                lessonPlan.main = (planData.main || []).map(id => lesson_plan.items.find(ex => ex.id === id)).filter(Boolean);
                lessonPlan.finish = (planData.finish || []).map(id => lesson_plan.items.find(ex => ex.id === id)).filter(Boolean);
                
                renderPlan();
            }
        } catch (error) { 
            console.error("Initialization Error:", error);
            alert("אירעה שגיאה בטעינת הדף. נסה לרענן.");
        }
    }

    function populateSubjectFilter() { $('subject-filter').innerHTML = '<option value="">כל הנושאים</option>' + allSubjects.map(s => `<option value="${s.name}">${s.name}</option>`).join(''); }
    
    function renderBank() {
        const bankEl = $('bank');
        const selectedSubject = $('subject-filter').value;
        const filteredExercises = selectedSubject ? allExercises.filter(ex => ex.subject === selectedSubject) : allExercises;
        bankEl.innerHTML = '';
        filteredExercises.forEach(ex => {
            const item = document.createElement('div');
            item.className = 'bankitem';
            item.innerHTML = `<strong>${ex.name}</strong><div class='muted'>${ex.category}</div>
                <div style='display:flex;flex-wrap:wrap;gap:6px;margin-top:6px'>
                    <button class='add-btn' data-id='${ex.id}' data-part='warmup'>➕ חימום</button>
                    <button class='add-btn' data-id='${ex.id}' data-part='main'>➕ עיקרי</button>
                    <button class='add-btn' data-id='${ex.id}' data-part='finish'>➕ סיום</button>
                    <button class='details-btn' data-id='${ex.id}' style='background:var(--muted);'>פרטים</button>
                </div>`;
            bankEl.appendChild(item);
        });
    }
    
    function renderPlan() {
        ['warmup', 'main', 'finish'].forEach(key => {
            const box = $(key);
            box.innerHTML = '';
            (lessonPlan[key] || []).forEach((ex, i) => {
                const el = document.createElement('div');
                el.className = 'exercise';
                el.innerHTML = `${ex.image_url ? `<img src='${ex.image_url}'>` : `<div style='width:72px;height:72px;border:1px dashed var(--line);'></div>`}
                    <div><strong>${i + 1}. ${ex.name}</strong><div class='muted'>${ex.category}</div></div>
                    <div class='act'><button class='del-btn' data-part='${key}' data-index='${i}' style='background:#ef4444;color:#fff'>מחק</button></div>`;
                box.appendChild(el);
            });
        });
        updateEquipment();
    }
    
    function updateEquipment() {
        const equipmentSet = new Set();
        Object.values(lessonPlan).flat().forEach(ex => { if(ex.equipment) ex.equipment.split(',').forEach(item => equipmentSet.add(item.trim())) });
        $('equipment').textContent = equipmentSet.size ? Array.from(equipmentSet).join(', ') : 'אין עדיין ציוד.';
    }

    $('bank').addEventListener('click', (e) => {
        const target = e.target;
        const id = parseInt(target.dataset.id);
        if (target.classList.contains('add-btn')) {
            const part = target.dataset.part;
            const exercise = allExercises.find(ex => ex.id === id);
            if (exercise && lessonPlan[part] && !lessonPlan[part].find(p => p.id === id)) {
                lessonPlan[part].push(exercise);
                renderPlan();
            }
        }
        if (target.classList.contains('details-btn')) {
            const exercise = allExercises.find(ex => ex.id === id);
            if(exercise) showDetailsModal(exercise);
        }
    });
    
    $('doc').addEventListener('click', (e) => {
        if(e.target.classList.contains('del-btn')) {
            const part = e.target.dataset.part;
            const index = parseInt(e.target.dataset.index);
            if(lessonPlan[part] && lessonPlan[part][index]) {
                lessonPlan[part].splice(index, 1);
                renderPlan();
            }
        }
    });

    function showDetailsModal(ex) {
        const modalBox = $('modal-box');
        modalBox.innerHTML = `<h2>${ex.name}</h2><p><strong>נושא:</strong> ${ex.subject}</p><p><strong>קטגוריה:</strong> ${ex.category}</p><p><strong>ציוד:</strong> ${ex.equipment || 'ללא'}</p><hr><p>${(ex.description || '').replace(/\n/g, '<br>')}</p>${ex.image_url ? `<img src="${ex.image_url}" style="width:100%;">` : ''}<button onclick="closeDetailsModal()" style="width:100%; margin-top: 15px;">סגור</button>`;
        $('details-modal').style.display = 'grid';
    }
    function closeDetailsModal() { $('details-modal').style.display = 'none'; }
    $('details-modal').onclick = (e) => { if (e.target.id === 'details-modal') closeDetailsModal(); };

    $('save-plan').addEventListener('click', async () => {
        const plan_data = {
            warmup: lessonPlan.warmup.map(ex => ex.id),
            main: lessonPlan.main.map(ex => ex.id),
            finish: lessonPlan.finish.map(ex => ex.id),
        };
        const payload = { name: $('plan-name').value, topic: $('topic').value, subject: $('subject-filter').value, notes: $('notes').value, plan_data };
        if (!payload.name) return alert('אנא הזן כותרת למערך השיעור.');
        
        const method = currentLessonId ? 'PUT' : 'POST';
        const url = currentLessonId ? `/api/lesson-plans/${currentLessonId}` : '/api/lesson-plans';
        
        try {
            await jsonFetch(url, { method: method, body: JSON.stringify(payload) });
            alert('המערך נשמר בהצלחה!');
            if (!currentLessonId) {
                lessonPlan = { warmup: [], main: [], finish: [] };
                renderPlan();
                $('plan-name').value = ''; $('topic').value = ''; $('notes').value = '';
            } else {
                location.href = '/my-lessons-pep';
            }
        } catch (error) { 
            alert(`שגיאה בשמירת המערך: ${error.message}`); 
        }
    });

    $('subject-filter').onchange = renderBank;
    
    initializePage();
</script>
</body>
</html>