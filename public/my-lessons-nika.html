<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>NIKA – המערכים שלי</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#fff7fb; --card:#ffffff; --text:#0f172a; --muted:#475569; --accent:#d946ef;
      --border:#f0def0; --pill-bg:#ffffff; --pill-shadow:0 8px 22px rgba(2,6,23,.08);
      --danger-bg: #fee2e2; --danger-text: #b91c1c; --admin-bg: #fef9c3; --admin-text: #713f12;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;font-family:Heebo,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{ display:flex;align-items:center;justify-content:space-between;gap:16px; padding:16px 20px;background:#fff;border-bottom:1px solid var(--border); }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{height:46px;width:auto;object-fit:contain}
    .brand h1{font-size:20px;margin:0;font-weight:900; line-height: 1.2;}
    .user-welcome { font-size: 16px; color: var(--muted); font-weight: 500; }
    #user-name-placeholder { font-weight: 700; color: var(--accent); }
    .nav-pills{display:flex;gap:12px; align-items: center;}
    .pill{ background:var(--pill-bg); border:1px solid var(--border); box-shadow:var(--pill-shadow); color:#0f172a; padding:10px 18px; border-radius:16px; font-size:16px; font-weight:800; cursor:pointer; text-decoration:none; transition:transform .05s ease; white-space:nowrap; }
    .pill.logout { background-color: var(--danger-bg); color: var(--danger-text); border-color: #fecaca; }
    .pill.admin-return { background-color: var(--admin-bg); color: var(--admin-text); border-color: #fde68a; display: none; }
    
    main{max-width:900px;margin:30px auto;padding:0 20px}
    .page-title { font-size: 2.5rem; font-weight: 900; margin-bottom: 24px; text-align: center; }
    #lessons-list { display: grid; gap: 16px; }
    .lesson-row {
        display: grid;
        grid-template-columns: 1fr auto auto;
        gap: 16px;
        align-items: center;
        background: var(--card);
        border: 1px solid var(--border);
        padding: 16px 20px;
        border-radius: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .lesson-info h3 { margin: 0; font-size: 1.2rem; }
    .lesson-info p { margin: 4px 0 0; font-size: 0.9rem; color: var(--muted); }
    .btn-pdf {
        background: var(--accent);
        color: white;
        text-decoration: none;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 14px;
        white-space: nowrap;
        transition: background-color 0.2s;
    }
    .btn-pdf[disabled] {
        background: #d4d4d8;
        cursor: not-allowed;
    }
    footer { text-align: center; padding: 24px; margin-top: 32px; color: var(--muted); font-size: 14px; border-top: 1px solid var(--border); }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="/assets/nika-logo.png" alt="NIKA">
    <div>
        <h1>NIKA</h1>
        <div class="user-welcome">שלום, <span id="user-name-placeholder">טוען...</span></div>
    </div>
  </div>
  <nav class="nav-pills">
    <a href="/api/auth/return-to-admin" id="return-to-admin-btn" class="pill admin-return">חזרה לממשק ניהול</a>
    <a class="pill" href="/nika-builder.html">בנה מערך חדש</a>
    <a class="pill logout" href="#" id="logout-btn">התנתק</a>
  </nav>
</header>

<main>
  <h1 class="page-title">המערכים השמורים שלי</h1>
  <div id="lessons-list">
    </div>
</main>

<footer> &copy; 2025 NIKA. כל הזכויות שמורות. </footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // === לוגיקה להצגת שם המשתמש וכפתור מנהל ===
    const userNameElement = document.getElementById('user-name-placeholder');
    const returnToAdminBtn = document.getElementById('return-to-admin-btn');
    fetch('/api/auth/me')
      .then(response => response.ok ? response.json() : Promise.reject('Not logged in'))
      .then(data => {
        if (data.user && data.user.fullname) {
          userNameElement.textContent = data.user.fullname;
        }
        if (data.viewAsOrg) {
          returnToAdminBtn.style.display = 'inline-flex';
        }
      })
      .catch(error => {
        console.error('Error fetching user status:', error);
        userNameElement.textContent = 'אורח';
      });

    // === לוגיקת התנתקות ===
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', function(event) {
        event.preventDefault();
        fetch('/api/auth/logout')
          .then(() => { window.location.href = '/nika-login.html'; })
          .catch(error => console.error('Logout failed:', error));
      });
    }

    // === לוגיקה מעודכנת לטעינת המערכים השמורים ===
    const lessonsListElement = document.getElementById('lessons-list');
    fetch('/api/my-lesson-plans')
        .then(response => {
            if (!response.ok) {
                throw new Error('Could not fetch lesson plans');
            }
            return response.json();
        })
        .then(data => {
            console.log('Data received from server:', data); // הדפסה לאבחון

            const nikaPlans = data.lesson_plans.filter(plan => plan.organization === 'NIKA');
            
            if (nikaPlans.length === 0) {
                lessonsListElement.innerHTML = '<p style="text-align:center;">עדיין לא שמרת מערכים.</p>';
                return;
            }

            nikaPlans.forEach(plan => {
                const date = new Date(plan.created_at);
                const formattedDate = date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });

                const planElement = document.createElement('div');
                planElement.className = 'lesson-row';
                
                let buttonHtml;
                // בדיקת בטיחות - ודא שה-ID קיים
                if (plan.id) {
                    buttonHtml = `<a href="/api/lesson-plans/${plan.id}/pdf" class="btn-pdf">הורד PDF</a>`;
                } else {
                    buttonHtml = `<button class="btn-pdf" disabled>PDF לא זמין</button>`;
                }

                planElement.innerHTML = `
                    <div class="lesson-info">
                        <h3>${escapeHTML(plan.name)}</h3>
                        <p>נוצר בתאריך: ${formattedDate}</p>
                    </div>
                    ${buttonHtml}
                `;
                lessonsListElement.appendChild(planElement);
            });
        })
        .catch(error => {
            console.error('Error fetching lesson plans:', error);
            lessonsListElement.innerHTML = '<p style="text-align:center; color: red;">אירעה שגיאה בטעינת המערכים.</p>';
        });
});

function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>'"]/g, 
        tag => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            "'": '&#39;',
            '"': '&quot;'
        }[tag] || tag)
    );
}
</script>

</body>
</html>