<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>כניסה — PE Planner</title>
  <style>
    body{margin:0;background-color:#f8fafc;font-family:system-ui,sans-serif;display:grid;place-items:center;min-height:100vh}
    .card{background-color:white;padding:2rem;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1);width:min(400px,90vw)}
    h1{margin:0 0 1rem;font-size:1.5rem}
    input,button{width:100%;padding:.75rem;border-radius:.5rem;border:1px solid #d1d5db;margin-bottom:1rem;box-sizing:border-box}
    button{background-color:#2563eb;color:white;font-weight:700;border:0;cursor:pointer}
    .muted{color:#6b7280;font-size:.875rem}
  </style>
</head>
<body>
  <div class="card">
    <h1>כניסה למערכת</h1>
    <input id="l-email" placeholder="אימייל" type="email" />
    <input id="l-pass" placeholder="סיסמה" type="password" />
    <button id="btn-login">כניסה</button>
    <div id="l-msg" class="muted"></div>
  </div>
  <script>
    const $ = (id) => document.getElementById(id);

    async function jsonFetch(url, opts = {}) {
        const r = await fetch(url, {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            ...opts
        });
        const d = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(d.error || 'שגיאה כללית');
        return d;
    }

    // בדיקה אם המשתמש כבר מחובר
    (async () => {
        try {
            const res = await jsonFetch('/api/auth/me');
            if (res.user) {
                let redirectUrl = '/members';
                if (res.user.role === 'admin') redirectUrl = '/admin';
                if (res.user.organization === 'NIKA') redirectUrl = '/nika/dashboard';
                location.href = redirectUrl;
            }
        } catch (e) {
            console.log("User not logged in, which is normal for the login page.");
        }
    })();

    // --- כאן הוספנו את נקודות הביקורת ---
    $('btn-login').onclick = async () => {
        console.log('Checkpoint 1: Login button clicked.');
        const email = $('l-email').value.trim();
        const password = $('l-pass').value;
        $('l-msg').textContent = '';

        try {
            console.log('Checkpoint 2: Sending login request to server...');
            const res = await jsonFetch('/api/users/login', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            console.log('Checkpoint 3: Received response from server:', res);

            if (res.redirectUrl) {
                console.log('Checkpoint 4: Redirecting to:', res.redirectUrl);
                location.href = res.redirectUrl;
            } else {
                console.log('Checkpoint 5: No redirectUrl found in response.');
                $('l-msg').textContent = 'ההתחברות הצליחה אך לא נמצאה כתובת להעברה.';
            }
        } catch (e) {
            console.error('Checkpoint 6: Login failed with error:', e);
            $('l-msg').textContent = e.message;
        }
    };
  </script>
</body>
</html>