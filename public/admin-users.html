<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ניהול משתמשים</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#f8fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --border:#e5e7eb; --accent:#2563eb; }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Heebo,system-ui,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 20px;background:#fff;border-bottom:1px solid var(--border)}
    .pill{background:#fff;border:1px solid var(--border);box-shadow:0 8px 22px rgba(2,6,23,.08);color:#0f172a;padding:10px 18px;border-radius:16px;font-size:16px;font-weight:800;text-decoration:none}
    main{max-width:1200px;margin:22px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}

    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    thead th{font-size:13px;color:var(--muted);text-align:right;padding:6px 12px}
    tbody td{background:#fff;border:1px solid var(--border);border-left:0;border-right:0;padding:14px 12px;font-size:15px}
    tbody tr td:first-child{border-radius:12px 0 0 12px;border-right:1px solid var(--border)}
    tbody tr td:last-child{border-radius:0 12px 12px 0;border-left:1px solid var(--border)}
    /* widen columns */
    .col-name{width:22%} .col-email{width:28%} .col-role{width:12%} .col-org{width:12%} .col-created{width:16%} .col-actions{width:10%}

    .chip{display:inline-block;background:#eef2ff;border:1px solid #c7d2fe;color:#1d4ed8;font-size:12px;padding:2px 8px;border-radius:999px}
    .btn{border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:8px 10px;font-size:13px;margin-inline:4px;cursor:pointer}
    .btn.danger{background:#fff0f0;border-color:#fecaca;color:#b91c1c}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    input,select{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
  </style>
</head>
<body>
<header>
  <h1 style="margin:0;font-size:20px">ניהול משתמשים</h1>
  <a class="pill" href="/admin">חזור לאזור ניהול</a>
</header>

<main>
  <div class="card">
    <div class="toolbar">
      <input id="email" placeholder="אימייל" />
      <input id="fullname" placeholder="שם מלא" />
      <input id="password" placeholder="סיסמה" type="password" />
      <select id="role">
        <option value="member">משתמש</option>
        <option value="admin">מנהל</option>
      </select>
      <select id="org">
        <option value="PEP">PEP</option>
        <option value="NIKA">NIKA</option>
      </select>
      <button id="create" class="btn" style="border-color:#2563eb;color:#2563eb">צור משתמש</button>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th class="col-name">שם</th>
          <th class="col-email">אימייל</th>
          <th class="col-role">תפקיד</th>
          <th class="col-org">ארגון</th>
          <th class="col-created">נוצר</th>
          <th class="col-actions">פעולות</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
(async () => {
  const tbody = document.querySelector('#tbl tbody');

  async function load(){
    const r = await fetch('/api/admin/users');
    if (!r.ok){ alert('שגיאה בטעינת משתמשים'); return; }
    const {users=[]} = await r.json();
    tbody.innerHTML = '';
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="col-name">${u.fullname || ''}</td>
        <td class="col-email">${u.email || ''}</td>
        <td class="col-role"><span class="chip">${u.role==='admin'?'מנהל':'משתמש'}</span></td>
        <td class="col-org">${u.organization || ''}</td>
        <td class="col-created">${(u.created_at||'').replace('T',' ').slice(0,19)}</td>
        <td class="col-actions">
          <button class="btn" data-act="edit" data-id="${u.id}">ערוך</button>
          <button class="btn danger" data-act="del" data-id="${u.id}">מחק</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  document.body.addEventListener('click', async (e)=>{
    const t = e.target;
    if (t.dataset.act === 'del'){
      if (!confirm('למחוק משתמש?')) return;
      const r = await fetch('/api/admin/users/'+t.dataset.id, {method:'DELETE'});
      if (!r.ok){ alert('שגיאה במחיקה'); return; }
      load();
    } else if (t.dataset.act === 'edit'){
      const email = prompt('אימייל חדש (השאר ריק כדי לא לשנות):');
      const fullname = prompt('שם מלא (השאר ריק כדי לא לשנות):');
      const role = prompt('role: admin/member (השאר ריק כדי לא לשנות):');
      const organization = prompt('ארגון: PEP/NIKA (השאר ריק כדי לא לשנות):');
      const payload = {};
      if (email) payload.email = email;
      if (fullname) payload.fullname = fullname;
      if (role) payload.role = role;
      if (organization) payload.organization = organization;
      if (!Object.keys(payload).length) return;
      const r = await fetch('/api/admin/users/'+t.dataset.id, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
      if (!r.ok){ alert('שגיאה בעדכון'); return; }
      load();
    }
  });

  document.getElementById('create').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const fullname = document.getElementById('fullname').value.trim();
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    const organization = document.getElementById('org').value;
    if (!email || !password){ alert('אימייל וסיסמה חובה'); return; }
    const r = await fetch('/api/admin/users', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, fullname, password, role, organization})});
    if (!r.ok){ const d = await r.json().catch(()=>({})); alert('שגיאה ביצירה: '+(d.error||r.status)); return; }
    document.getElementById('email').value='';
    document.getElementById('fullname').value='';
    document.getElementById('password').value='';
    load();
  };

  load();
})();
</script>
</body>
</html>
