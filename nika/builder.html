<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NIKA LET’S PLAY — בניית מערך משחקים</title>
  <style>
    :root{--bg:#f4f7fb;--ink:#0b1324;--muted:#64748b;--line:#e2e8f0;--brand:#0ea5e9;--card:#fff}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,Heebo,Arial;color:var(--ink)}
    header{position:sticky;top:0;background:#ffffffe6;backdrop-filter:blur(8px);border-bottom:1px solid var(--line);padding:12px 16px;display:flex;gap:10px;align-items:center}
    .wrap{max-width:960px;margin:16px auto;padding:0 14px}
    button,select,input,textarea{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff}
    button.primary{background:linear-gradient(90deg,#0ea5e9,#22d3ee);border:0;color:#fff;font-weight:900}

    .paper{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.05);padding:18px}
    .title{font-size:26px;font-weight:900;margin:0 0 6px}
    .meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
    .section{margin-top:16px}
    .section h3{margin:0 0 8px;border-bottom:2px solid var(--line);padding-bottom:6px}
    .game{border:1px solid var(--line);border-radius:12px;padding:10px;margin:8px 0;display:grid;grid-template-columns:100px 1fr auto;gap:10px;align-items:center}
    .game img{width:100px;height:100px;object-fit:cover;border-radius:10px;border:1px solid var(--line)}
    .game .act button{margin-inline-start:6px}
    textarea.notes{width:100%;min-height:100px}

    details.bank{margin:12px 0}
    .bankbox{border:1px dashed var(--line);border-radius:12px;padding:10px}
    .bankgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .bankitem{border:1px solid var(--line);border-radius:12px;padding:8px}

    @media print{ header,details.bank,.bar{display:none} body{background:#fff} .wrap{max-width:none} .paper{border:0;box-shadow:none;padding:0} .game{page-break-inside:avoid} }
    .bar{position:sticky;bottom:10px;display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;box-shadow:0 20px 60px rgba(0,0,0,.08);margin-top:12px}
    .water{position:fixed;inset:0;pointer-events:none;opacity:.06;display:none;place-items:center}
    .water img{width:520px;opacity:.28}
  </style>
</head>
<body>
<header>
  <img src="/assets/nika-logo.png" alt="NIKA" style="height:80px"/>
  <strong>LET’S PLAY — בניית מערך משחקים</strong>
  <div style="margin-inline-start:auto"></div>
  <button id="btn-members">אזור לקוחות</button>
  <button id="btn-admin">ניהול ניקה</button>
</header>

<div class="wrap">
  <details class="bank" open>
    <summary><strong>➕ הוספת משחקים מבנק NIKA</strong></summary>
    <div class="bankbox">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <label>גיל יעד:</label>
        <select id="age">
          <option value="">הכול</option>
          <option>כיתות א׳-ג׳</option>
          <option>כיתות ד׳-ו׳</option>
          <option>חטיבה</option>
        </select>
        <input id="q" placeholder="חיפוש בשם/תיאור" style="min-width:240px" />
        <button id="load">טען</button>
        <div id="coachBox" class="muted" style="margin-inline-start:auto">מאמן: —</div>
      </div>
      <div id="bank" class="bankgrid"></div>
    </div>
  </details>

  <div class="paper" id="doc">
    <input id="title" class="title" placeholder="כותרת מערך משחקים (למשל: ניקה — הפעלה 1)"/>
    <div class="meta">
      <div><label>מטרת ההפעלה</label><input id="goal" placeholder="למשל: עבודת צוות"/></div>
      <div><label>משך (דקות)</label><input id="minutes" type="number" value="45"/></div>
    </div>

    <div class="section">
      <h3>ציוד נדרש (נאגר אוטומטית)</h3>
      <div id="equipment" class="muted">אין עדיין ציוד. הוסיפו משחקים — ואסכם כאן.</div>
    </div>

    <div class="section" id="sec-warmup">
      <h3>חלק ראשון — חימום</h3>
      <div id="warmup"></div>
    </div>

    <div class="section" id="sec-main">
      <h3>חלק שני — עיקרי</h3>
      <div id="main"></div>
    </div>

    <div class="section" id="sec-finish">
      <h3>חלק שלישי — סיום</h3>
      <div id="finish"></div>
    </div>

    <div class="section">
      <h3>הערות המאמן</h3>
      <textarea id="notes" class="notes" placeholder="דגשים, התאמות לקבוצה…"></textarea>
    </div>
  </div>

  <div class="bar">
    <button id="save" class="primary">שמור טיוטה</button>
    <button id="export" class="primary">ייצוא PDF</button>
  </div>

  <div class="water" id="wm"><img src="/assets/nika-logo-white.png" alt="NIKA watermark"/></div>
</div>

<script>
  const API=location.origin,$=(id)=>document.getElementById(id);
  async function jsonFetch(url,opts={}){ const r=await fetch(url,{credentials:'include',headers:{'Content-Type':'application/json'},...opts}); let d={}; try{ d=await r.json(); }catch{} if(!r.ok) throw new Error(d.error||'שגיאה'); return d; }

  let bank=[], plan={warmup:[],main:[],finish:[]}, coachName='';

  (async()=>{
    try{ const me=await jsonFetch(`${API}/api/auth/me`); if(me?.user){ coachName=me.user.fullname||me.user.email; $('coachBox').textContent=`מאמן: ${coachName}`; } }
    catch{}
    await loadBank();
    try{ const d=JSON.parse(localStorage.getItem('nikaPlanV1')||'{}'); if(d&&d.warmup){ plan=d; } }catch{}
    renderAll();
  })();

  async function loadBank(){
    const q=$('q').value.toLowerCase().trim();
    const age=$('age').value;
    const url=`${API}/api/exercises?subject=${encodeURIComponent('NIKA — משחקים')}`;
    try{
      const rows=await jsonFetch(url);
      bank=rows.filter(r=>r.is_public && (!q || (r.name||'').toLowerCase().includes(q) || (r.description||'').toLowerCase().includes(q)) && (!age || (r.age_group||'').includes(age)) );
      renderBank();
    }catch(e){ alert('שגיאה בטעינת בנק המשחקים: '+e.message); }
  }

  function renderBank(){
    const box=$('bank'); box.innerHTML='';
    if(!bank.length){ box.innerHTML='<div class="muted">אין משחקים להציג עדיין.</div>'; return; }
    bank.forEach(r=>{
      const d=document.createElement('div');
      d.className='bankitem';
      d.innerHTML=`<strong>${r.name||'ללא שם'}</strong>
        <div class='muted' style='font-size:12px'>${r.category||''}</div>
        <div style='font-size:13px;color:#64748b;margin-top:4px'>${((r.description||'').replace(/</g,'&lt;').slice(0,120))}...</div>
        <div style='display:flex;gap:6px;margin-top:6px'>
          <button data-id='${r.id}' data-part='warmup'>➕ חימום</button>
          <button data-id='${r.id}' data-part='main'>➕ עיקרי</button>
          <button data-id='${r.id}' data-part='finish'>➕ סיום</button>
        </div>`;
      box.appendChild(d);
    });
  }

  document.addEventListener('click', (e)=>{
    const addBtn=e.target.closest('#bank button');
    if(addBtn){ const id=+addBtn.dataset.id, key=addBtn.dataset.part; const ex=bank.find(x=>x.id===id); if(!ex) return; plan[key].push(ex); persist(); renderAll(); return; }
    const docBtn=e.target.closest('#doc .act button');
    if(docBtn){ const k=docBtn.dataset.k, i=+docBtn.dataset.i, a=docBtn.dataset.a; const arr=plan[k]; if(!arr||!arr[i]) return; if(a==='up'&&i>0){ [arr[i-1],arr[i]]=[arr[i],arr[i-1]]; } else if(a==='down'&&i<arr.length-1){ [arr[i+1],arr[i]]=[arr[i],arr[i+1]]; } else if(a==='del'){ arr.splice(i,1); } else if(a==='move'){ const to=k==='warmup'?'main':(k==='main'?'finish':'warmup'); plan[to].push(arr.splice(i,1)[0]); }
      persist(); renderAll(); return; }
  });

  $('load').onclick=loadBank; $('age').onchange=loadBank; $('q').addEventListener('keyup',e=>{ if(e.key==='Enter') loadBank(); });

  function renderAll(){
    ['warmup','main','finish'].forEach(key=>{
      const box=$(key); box.innerHTML='';
      plan[key].forEach((r,i)=>{
        const el=document.createElement('div'); el.className='game';
        const safeDesc=(r.description||'').replace(/</g,'&lt;').replace(/\n/g,'<br>');
        el.innerHTML=`${r.image_url?`<img src='${r.image_url}'>`:
          "<div style='width:100px;height:100px;border:1px dashed var(--line);border-radius:10px;display:grid;place-items:center;color:#94a3b8'>אין תמונה</div>"}
          <div><strong>${i+1}. ${r.name||'ללא שם'}</strong>
            <div class='muted' style='font-size:12px'>${r.category||''}</div>
            <div class='muted' style='font-size:13px;margin-top:4px'>${safeDesc}</div>
          </div>
          <div class='act'>
            <button data-k='${key}' data-i='${i}' data-a='up'>↑</button>
            <button data-k='${key}' data-i='${i}' data-a='down'>↓</button>
            <button data-k='${key}' data-i='${i}' data-a='move'>↔ העבר</button>
            <button data-k='${key}' data-i='${i}' data-a='del' style='background:#ef4444;color:#fff'>מחק</button>
          </div>`;
        box.appendChild(el);
      });
    });
    updateEquipment();
  }

  function extractEquipment(txt=''){
    const lines=String(txt).split(/\n|<br\s*\/?\s*>/i); let found=[]; lines.forEach(L=>{ const m=L.match(/^(?:ציוד|ציוד נדרש)\s*[:\-]\s*(.+)$/i); if(m){ found.push(m[1]); } });
    const raw=found.join(',');
    return raw.split(/[,•;]+/).map(s=>s.trim()).filter(Boolean);
  }
  function updateEquipment(){
    const set=new Set();
    [...plan.warmup,...plan.main,...plan.finish].forEach(ex=> extractEquipment(ex.description).forEach(x=>set.add(x)) );
    $('equipment').textContent = set.size? Array.from(set).join(', ') : 'אין עדיין ציוד. הוסיפו משחקים — ואסכם כאן.';
  }

  function persist(){ localStorage.setItem('nikaPlanV1', JSON.stringify(plan)); }

  $('save').onclick=()=>{ persist(); alert('נשמר בדפדפן כטיוטה'); };
  $('export').onclick=()=>{ const wm=$('wm'); wm.style.display='grid'; setTimeout(()=>{ window.print(); setTimeout(()=> wm.style.display='none', 300); }, 60); };
  $('btn-members').onclick=()=>location.href='/members';
  $('btn-admin').onclick=()=>location.href='/admin';
</script>
</body>
</html>
